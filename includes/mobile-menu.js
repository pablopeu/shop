/**
 * Mobile Menu Hamburger Component
 * Handles opening/closing of mobile navigation drawer
 * HTML is generated by includes/mobile-menu.php
 */

(function() {
    'use strict';

    // Create hamburger button element
    function createHamburgerButton() {
        const btn = document.createElement('button');
        btn.className = 'mobile-menu-toggle';
        btn.setAttribute('aria-label', 'Men√∫');
        btn.innerHTML = `
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
        return btn;
    }

    // Initialize mobile menu
    function initMobileMenu() {
        console.log('Mobile menu: Initializing...');

        // Check if drawer exists (should be included via mobile-menu.php)
        const drawer = document.querySelector('.mobile-menu-drawer');
        if (!drawer) {
            console.error('Mobile menu: Drawer not found! Make sure mobile-menu.php is included.');
            return;
        }

        // Get compact header (always exists from mobile-menu.php)
        const compactHeader = document.querySelector('.header-compact');
        if (!compactHeader) {
            console.error('Mobile menu: Compact header not found!');
            return;
        }

        const headerContent = compactHeader.querySelector('.header-content');
        if (!headerContent) {
            console.error('Mobile menu: Header content not found!');
            return;
        }

        // Check if already initialized
        if (headerContent.querySelector('.mobile-menu-toggle')) {
            console.log('Mobile menu: Already initialized');
            return;
        }

        console.log('Mobile menu: Compact header found');

        // Create hamburger button for compact header
        const compactHamburgerBtn = createHamburgerButton();
        headerContent.appendChild(compactHamburgerBtn);
        console.log('Mobile menu: Hamburger button added to compact header');

        // Also add hamburger to normal header if it exists (for pages with header)
        const normalHeader = document.querySelector('.header .header-content');
        if (normalHeader && !normalHeader.querySelector('.mobile-menu-toggle')) {
            const normalHamburgerBtn = createHamburgerButton();
            normalHeader.appendChild(normalHamburgerBtn);
            normalHamburgerBtn.addEventListener('click', openMenu);
            console.log('Mobile menu: Hamburger button added to normal header');
        }

        // Setup event listeners
        const overlay = document.querySelector('.mobile-menu-overlay');
        const closeBtn = drawer.querySelector('.mobile-menu-close');

        compactHamburgerBtn.addEventListener('click', openMenu);
        if (overlay) overlay.addEventListener('click', closeMenu);
        if (closeBtn) closeBtn.addEventListener('click', closeMenu);

        // Close on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && drawer.classList.contains('active')) {
                closeMenu();
            }
        });

        // Setup scroll detection for compact header
        setupScrollHeader(compactHeader);

        // Update cart count when it changes
        const cartCountElement = document.getElementById('cart-count');
        if (cartCountElement) {
            const observer = new MutationObserver(() => {
                updateCartBadge();
            });

            observer.observe(cartCountElement, {
                childList: true,
                characterData: true,
                subtree: true
            });
        }

        console.log('Mobile menu: Initialization complete!');
    }

    // Setup scroll detection for compact header
    function setupScrollHeader(compactHeader) {
        const normalHeader = document.querySelector('.header');
        let lastScrollTop = 0;
        const scrollThreshold = 50; // Show compact header after scrolling 50px

        function handleScroll() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const isMobile = window.innerWidth <= 768;

            // Only show compact header on mobile devices
            if (isMobile && scrollTop > scrollThreshold) {
                compactHeader.classList.add('visible');
                // Hide normal header if it exists
                if (normalHeader) {
                    normalHeader.classList.add('hidden-on-scroll');
                }
            } else {
                compactHeader.classList.remove('visible');
                // Show normal header if it exists
                if (normalHeader) {
                    normalHeader.classList.remove('hidden-on-scroll');
                }
            }

            lastScrollTop = scrollTop;
        }

        // Initial check
        handleScroll();

        // Listen to scroll events (throttled)
        let ticking = false;
        window.addEventListener('scroll', () => {
            if (!ticking) {
                window.requestAnimationFrame(() => {
                    handleScroll();
                    ticking = false;
                });
                ticking = true;
            }
        });

        // Listen to resize events
        window.addEventListener('resize', handleScroll);
    }

    function updateCartBadge() {
        const cartCountElement = document.getElementById('cart-count');
        const drawer = document.querySelector('.mobile-menu-drawer');

        if (!cartCountElement || !drawer) return;

        const newCount = cartCountElement.textContent.trim();
        let badge = drawer.querySelector('.mobile-menu-badge');
        const cartLink = drawer.querySelector('#mobile-cart-link');

        if (!cartLink) return;

        if (newCount !== '0' && newCount !== '') {
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'mobile-menu-badge';
                cartLink.appendChild(badge);
            }
            badge.textContent = newCount;
        } else if (badge) {
            badge.remove();
        }
    }

    function openMenu() {
        console.log('Mobile menu: Opening menu...');
        const toggles = document.querySelectorAll('.mobile-menu-toggle');
        const overlay = document.querySelector('.mobile-menu-overlay');
        const drawer = document.querySelector('.mobile-menu-drawer');

        if (!overlay || !drawer) {
            console.error('Mobile menu: Cannot open - elements not found', { overlay, drawer });
            return;
        }

        // Add active class to all toggle buttons
        toggles.forEach(toggle => toggle.classList.add('active'));
        overlay.classList.add('active');
        drawer.classList.add('active');
        document.body.classList.add('mobile-menu-open');
        console.log('Mobile menu: Menu opened');

        // Trap focus in drawer
        const focusableElements = drawer.querySelectorAll('a, button');
        if (focusableElements.length > 0) {
            focusableElements[0].focus();
        }
    }

    function closeMenu() {
        console.log('Mobile menu: Closing menu...');
        const toggles = document.querySelectorAll('.mobile-menu-toggle');
        const overlay = document.querySelector('.mobile-menu-overlay');
        const drawer = document.querySelector('.mobile-menu-drawer');

        if (!overlay || !drawer) {
            console.error('Mobile menu: Cannot close - elements not found');
            return;
        }

        // Remove active class from all toggle buttons
        toggles.forEach(toggle => toggle.classList.remove('active'));
        overlay.classList.remove('active');
        drawer.classList.remove('active');
        document.body.classList.remove('mobile-menu-open');
        console.log('Mobile menu: Menu closed');
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMobileMenu);
    } else {
        initMobileMenu();
    }

    // Expose close function globally for external use
    window.closeMobileMenu = closeMenu;
})();
